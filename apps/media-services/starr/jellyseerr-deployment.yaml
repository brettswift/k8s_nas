apiVersion: apps/v1
kind: Deployment
metadata:
  name: jellyseerr
  namespace: media
  labels:
    app: jellyseerr
spec:
  replicas: 1
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: jellyseerr
  template:
    metadata:
      labels:
        app: jellyseerr
    spec:
      initContainers:
      - name: jellyseerr-config-init
        image: fallenbagel/jellyseerr:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -eu
          CONFIG="/app/config/settings.json"
          mkdir -p /app/config
          
          # If settings.json doesn't exist, create minimal structure
          if [ ! -f "$CONFIG" ]; then
            node -e "
              const fs = require('fs');
              const settings = {
                sonarr: [],
                radarr: [],
                main: { defaultPermissions: 160 }
              };
              fs.writeFileSync('$CONFIG', JSON.stringify(settings, null, 2));
            "
          fi
          
          # Read current settings and update Sonarr/Radarr config
          node -e "
            const fs = require('fs');
            const settings = JSON.parse(fs.readFileSync('$CONFIG', 'utf8'));
            
            // Sonarr configuration
            const sonarrConfig = {
              name: 'Sonarr',
              hostname: 'sonarr',
              port: 8989,
              ssl: false,
              apiKey: process.env.SONARR_API_KEY,
              baseUrl: '',
              use4k: false,
              isDefault: true,
              is4k: false,
              activeProfileId: 1,
              activeDirectory: '/data/media/series',
              activeLanguageProfileId: 1,
              activeAnimeProfileId: 1,
              activeAnimeDirectory: '/data/media/series',
              activeAnimeLanguageProfileId: 1,
              syncEnabled: true,
              syncInterval: 360
            };
            
            // Radarr configuration
            const radarrConfig = {
              name: 'Radarr',
              hostname: 'radarr',
              port: 7878,
              ssl: false,
              apiKey: process.env.RADARR_API_KEY,
              baseUrl: '',
              use4k: false,
              isDefault: true,
              is4k: false,
              activeProfileId: 1,
              activeDirectory: '/data/media/movies',
              activeLanguageProfileId: 1,
              activeAnimeProfileId: 1,
              activeAnimeDirectory: '/data/media/movies',
              activeAnimeLanguageProfileId: 1,
              syncEnabled: true,
              syncInterval: 360
            };
            
            // Only update if not already configured
            if (!settings.sonarr || settings.sonarr.length === 0) {
              settings.sonarr = [sonarrConfig];
            } else {
              // Update existing if API key matches or is empty
              const existing = settings.sonarr[0];
              if (!existing.apiKey || existing.apiKey === process.env.SONARR_API_KEY) {
                settings.sonarr[0] = { ...existing, ...sonarrConfig };
              }
            }
            
            if (!settings.radarr || settings.radarr.length === 0) {
              settings.radarr = [radarrConfig];
            } else {
              const existing = settings.radarr[0];
              if (!existing.apiKey || existing.apiKey === process.env.RADARR_API_KEY) {
                settings.radarr[0] = { ...existing, ...radarrConfig };
              }
            }
            
            fs.writeFileSync('$CONFIG', JSON.stringify(settings, null, 2));
          "
        env:
        - name: SONARR_API_KEY
          valueFrom:
            secretKeyRef:
              name: starr-secrets
              key: SONARR_API_KEY
        - name: RADARR_API_KEY
          valueFrom:
            secretKeyRef:
              name: starr-secrets
              key: RADARR_API_KEY
        volumeMounts:
        - name: config
          mountPath: /app/config
      containers:
      - name: jellyseerr
        image: fallenbagel/jellyseerr:latest
        ports:
        - containerPort: 5055
          name: http
        env:
        - name: LOG_LEVEL
          value: "debug"
        - name: DEBUG
          value: "1"
        - name: TZ
          valueFrom:
            configMapKeyRef:
              name: starr-common-config
              key: TZ
        volumeMounts:
        - name: config
          mountPath: /app/config
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/v1/status
            port: 5055
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/v1/status
            port: 5055
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: jellyseerr-config
---
apiVersion: v1
kind: Service
metadata:
  name: jellyseerr
  namespace: media
  labels:
    app: jellyseerr
spec:
  selector:
    app: jellyseerr
  ports:
  - name: http
    port: 5055
    targetPort: 5055
  type: ClusterIP
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyseerr-config
  namespace: media
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path
